<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Safari Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #007AFF; }
        .result { background: #e8f5e8; padding: 10px; margin: 5px 0; border: 1px solid #4caf50; }
        .error { background: #ffe8e8; padding: 10px; margin: 5px 0; border: 1px solid #f44336; }
        button { background: #007AFF; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .info { background: #fff3cd; padding: 10px; margin: 10px 0; border: 1px solid #ffc107; }
    </style>
</head>
<body>
    <h1>üß≠ Real Safari Authentication Test</h1>
    
    <div class="info">
        <strong>Instructions:</strong> Open this file in real Safari to test authentication behavior.
        <br><strong>Current Browser:</strong> <span id="browser-info"></span>
        <br><strong>Server Required:</strong> Make sure your dev server is running on localhost:9002
    </div>

    <div class="test-step">
        <h3>Step 1: Browser Detection</h3>
        <button type="button" onclick="testBrowserDetection()">Test Browser Detection</button>
        <div id="browser-results"></div>
    </div>

    <div class="test-step">
        <h3>Step 2: Popup Test</h3>
        <button type="button" onclick="testPopupBlocking()">Test Popup Blocking</button>
        <div id="popup-results"></div>
    </div>

    <div class="test-step">
        <h3>Step 3: Authentication Flow</h3>
        <button type="button" onclick="testAuthFlow()">Test Login Page</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-step">
        <h3>Step 4: Manual Session Test</h3>
        <button type="button" onclick="testManualSession()">Create Manual Session</button>
        <div id="session-results"></div>
    </div>

    <div class="test-step">
        <h3>Step 5: Admin Access Test</h3>
        <button type="button" onclick="testAdminAccess()">Test Admin Access</button>
        <div id="admin-results"></div>
    </div>

    <script>
        // Display browser info
        document.getElementById('browser-info').textContent = navigator.userAgent;

        function log(elementId, message, type = 'result') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            element.appendChild(div);
        }

        function testBrowserDetection() {
            const results = document.getElementById('browser-results');
            results.innerHTML = '';
            
            const userAgent = navigator.userAgent;
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent) && !/Chromium/.test(userAgent);
            
            log('browser-results', `User Agent: ${userAgent}`);
            log('browser-results', `Detected as Safari: ${isSafari ? '‚úÖ YES' : '‚ùå NO'}`);
            
            if (isSafari) {
                log('browser-results', 'üéâ This is real Safari! Results will be accurate.', 'result');
            } else {
                log('browser-results', '‚ö†Ô∏è This is not Safari. Results may not represent real Safari behavior.', 'error');
            }
        }

        function testPopupBlocking() {
            const results = document.getElementById('popup-results');
            results.innerHTML = '';
            
            try {
                const popup = window.open('', '_blank', 'width=1,height=1');
                if (popup) {
                    popup.close();
                    log('popup-results', '‚úÖ Popup test: ALLOWED - Popups are enabled');
                } else {
                    log('popup-results', '‚ùå Popup test: BLOCKED - Popups are disabled', 'error');
                }
            } catch (e) {
                log('popup-results', `‚ùå Popup test: ERROR - ${e.message}`, 'error');
            }
        }

        function testAuthFlow() {
            const results = document.getElementById('auth-results');
            results.innerHTML = '';
            
            log('auth-results', 'üîÑ Opening login page in new tab...');
            
            try {
                const loginWindow = window.open('http://localhost:9002/login', '_blank');
                if (loginWindow) {
                    log('auth-results', '‚úÖ Login page opened successfully');
                    log('auth-results', 'üëÅÔ∏è MANUAL CHECK: Look at the login page for Safari warnings');
                    log('auth-results', 'üñ±Ô∏è MANUAL CHECK: Click Google sign-in button');
                    log('auth-results', 'üìù MANUAL CHECK: Note if popup opens or page redirects');
                } else {
                    log('auth-results', '‚ùå Could not open login page', 'error');
                }
            } catch (e) {
                log('auth-results', `‚ùå Error opening login page: ${e.message}`, 'error');
            }
        }

        async function testManualSession() {
            const results = document.getElementById('session-results');
            results.innerHTML = '';
            
            const testUser = {
                uid: 'real-safari-test-' + Date.now(),
                email: 'realsafari@example.com'
            };
            
            try {
                log('session-results', 'üîÑ Creating manual session...');
                
                const response = await fetch('http://localhost:9002/api/auth/dev-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: testUser })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('session-results', '‚úÖ Manual session created successfully');
                    log('session-results', `üë§ User: ${result.user.email}`);
                    log('session-results', `üîß Mode: ${result.mode}`);
                } else {
                    log('session-results', '‚ùå Manual session creation failed', 'error');
                    log('session-results', `Error: ${result.error}`, 'error');
                }
            } catch (e) {
                log('session-results', `‚ùå Network error: ${e.message}`, 'error');
            }
        }

        async function testAdminAccess() {
            const results = document.getElementById('admin-results');
            results.innerHTML = '';
            
            try {
                log('admin-results', 'üîÑ Testing admin access...');
                
                // First check session status
                const sessionResponse = await fetch('http://localhost:9002/api/auth/session', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const sessionData = await sessionResponse.json();
                
                if (sessionData.authenticated) {
                    log('admin-results', '‚úÖ Session check: Authenticated');
                    log('admin-results', `üë§ User: ${sessionData.user.email}`);
                } else {
                    log('admin-results', '‚ùå Session check: Not authenticated', 'error');
                }
                
                // Test admin page access
                log('admin-results', 'üîÑ Opening admin page...');
                const adminWindow = window.open('http://localhost:9002/admin', '_blank');
                
                if (adminWindow) {
                    log('admin-results', '‚úÖ Admin page opened');
                    log('admin-results', 'üëÅÔ∏è MANUAL CHECK: Does it show admin panel or redirect to login?');
                    log('admin-results', 'üìù MANUAL CHECK: What authentication status is displayed?');
                } else {
                    log('admin-results', '‚ùå Could not open admin page', 'error');
                }
                
            } catch (e) {
                log('admin-results', `‚ùå Error testing admin access: ${e.message}`, 'error');
            }
        }

        // Auto-run browser detection on load
        window.onload = function() {
            testBrowserDetection();
        };
    </script>
</body>
</html>