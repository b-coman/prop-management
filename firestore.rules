
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // Helper Functions
    // ============================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function userExists() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Role-based checks
    function isSuperAdmin() {
      return userExists() && getUserData().role == 'super_admin';
    }

    function isPropertyOwner() {
      return userExists() && getUserData().role == 'property_owner';
    }

    // Check if user can manage a specific property
    function canManageProperty(propertyId) {
      return isSuperAdmin() ||
             (isPropertyOwner() && propertyId in getUserData().managedProperties);
    }

    // ============================================================================
    // Properties Collection
    // ============================================================================

    match /properties/{propertySlug} {
      allow read: if true; // Publicly readable

      // Create/delete requires super admin
      allow create: if isSuperAdmin();
      allow delete: if isSuperAdmin();

      // Update requires property management access
      allow update: if canManageProperty(propertySlug);
    }

    // PropertyOverrides collection
    match /propertyOverrides/{propertyId} {
      allow read: if true;
      allow write: if canManageProperty(propertyId);
    }

    // WebsiteTemplates collection
    match /websiteTemplates/{templateId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // Availability Collection
    // ============================================================================
    //
    // SECURITY NOTE: This collection has permissive write rules because:
    // 1. The public booking flow (bookingService.ts) uses Client SDK
    // 2. Client SDK on server has no Firebase Auth context
    // 3. Therefore, auth-based rules would break the booking flow
    //
    // RECOMMENDATION: Migrate bookingService.ts to use Admin SDK, then
    // change rules to: allow write: if false; (Admin SDK bypasses rules)
    //
    // Current mitigations:
    // - All admin operations use Admin SDK (bypasses these rules)
    // - Document IDs follow format: {propertyId}_{YYYY-MM}
    // - Delete is blocked to prevent accidental data loss
    //
    match /availability/{documentId} {
      allow read: if true;
      // Create/update needed for booking flow (uses Client SDK)
      // TODO: Migrate bookingService.ts to Admin SDK, then set to false
      allow create, update: if true;
      // Block delete to prevent accidental data loss
      allow delete: if false;
    }

    // ============================================================================
    // Bookings Collection
    // ============================================================================

    match /bookings/{bookingId} {
      allow create: if true; // Anyone can create a booking
      allow read: if true;   // Public read for confirmation page

      // Updates for payment processing or by authorized users
      allow update: if request.resource.data.paymentInfo != null ||
                    (isSignedIn() &&
                     (resource.data.guestInfo.userId == request.auth.uid ||
                      canManageProperty(resource.data.propertyId)));
    }

    // ============================================================================
    // Users Collection
    // ============================================================================

    match /users/{userId} {
      // Users can read/write their own document
      // Super admins can read/write any user
      allow read, write: if request.auth.uid == userId || isSuperAdmin();
    }

    // ============================================================================
    // Reviews Collection
    // ============================================================================

    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin();
    }

    // ============================================================================
    // Settings Collection
    // ============================================================================

    match /settings/{document} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // SyncCalendars Collection (legacy)
    // ============================================================================

    match /syncCalendars/{documentId} {
      allow read, write: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    // ============================================================================
    // iCal Feeds Collection
    // ============================================================================

    match /icalFeeds/{feedId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && canManageProperty(request.resource.data.propertyId);
      allow update, delete: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    // ============================================================================
    // Housekeeping Collections
    // ============================================================================

    match /housekeepingContacts/{contactId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && canManageProperty(request.resource.data.propertyId);
      allow update, delete: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    match /housekeepingMessages/{messageId} {
      allow read: if isSignedIn();
      allow write: if false;  // Admin SDK only
    }

    // ============================================================================
    // Coupons Collection
    // ============================================================================

    match /coupons/{couponId} {
      allow read: if true; // Needed by booking form validation
      // Only super admins can manage coupons (global resource)
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // Guests Collection
    // ============================================================================

    match /guests/{guestId} {
      allow read: if isSuperAdmin() || isPropertyOwner();
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // App Config
    // ============================================================================

    match /appConfig/{configDocId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // Inquiries Collection
    // ============================================================================

    match /inquiries/{inquiryId} {
      allow create: if true; // Anyone can create an inquiry
      allow read, update: if isSignedIn() &&
                          (resource.data.guestInfo.email == request.auth.token.email ||
                           canManageProperty(resource.data.propertySlug));
    }

    // ============================================================================
    // Pricing Collections
    // ============================================================================

    // Seasonal Pricing
    match /seasonalPricing/{seasonId} {
      allow read: if true; // Public read for price calculations
      allow create: if isSignedIn() && canManageProperty(request.resource.data.propertyId);
      allow update, delete: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    // Date Overrides
    match /dateOverrides/{overrideId} {
      allow read: if true; // Public read for price calculations
      allow create: if isSignedIn() && canManageProperty(request.resource.data.propertyId);
      allow update, delete: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    // Minimum Stay Rules
    match /minimumStayRules/{ruleId} {
      allow read: if true;
      allow create: if isSignedIn() && canManageProperty(request.resource.data.propertyId);
      allow update, delete: if isSignedIn() && canManageProperty(resource.data.propertyId);
    }

    // Holidays (global - super admin only)
    match /holidays/{holidayId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Pricing Templates (global - super admin only)
    match /pricingTemplates/{templateId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Price Calendars (generated by system)
    match /priceCalendars/{calendarId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // ============================================================================
    // Reference Data Collections
    // ============================================================================

    match /amenities/{amenityId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /features/{featureId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

  }
}
