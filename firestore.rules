
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(propertyId) {
      // Check if the user is signed in and if the property document exists and has an ownerId matching the user's UID
      return isSignedIn() &&
             exists(/databases/$(database)/documents/properties/$(propertyId)) &&
             get(/databases/$(database)/documents/properties/$(propertyId)).data.ownerId == request.auth.uid;
    }

    function isAdmin() {
      // Check if the user is signed in and if their user document exists and has the role 'admin'
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

 // --- Properties Collection ---
    match /properties/{propertySlug} {
      allow read: if true; // Publicly readable
      // Production rules - admin only for all write operations
      // Requires: users/{uid}.role == 'admin'
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // PropertyOverrides collection
    match /propertyOverrides/{propertyId} {
      allow read: if true;
      allow write: if isOwner(propertyId) || isAdmin();
    }
    
    // WebsiteTemplates collection
		match /websiteTemplates/{templateId} {
		 	allow read: if true; // Public read access
  		allow write: if isAdmin(); // Only admins can create/update/delete templates
		}


    // Availability collection
    match /availability/{documentId} {
      allow read: if true; // Public read access

      // Availability updates come from:
      // 1. Booking confirmations (server actions with Client SDK)
      // 2. Admin operations
      // 3. Cron jobs (use Admin SDK, bypass rules)
      //
      // For now, keep open for booking flow to work.
      // TODO: Refactor bookingService to use Admin SDK, then tighten these rules
      // See: docs/FIRESTORE_PRODUCTION_READINESS.md - Future Considerations
      allow create: if true;
      allow update: if true;
    }


    // --- Bookings Collection ---
      match /bookings/{bookingId} {
        // Allow anyone to create a pending booking
        allow create: if true;

        // Allow public read access for booking confirmation page
        allow read: if true;

        // Allow updates for payment processing (look for specific fields being updated)
        allow update: if request.resource.data.paymentInfo != null ||
                      (isSignedIn() &&
                       (resource.data.guestInfo.userId == request.auth.uid || // Guest who made booking
                        isOwner(resource.data.propertyId) ||                 // Property owner
                        isAdmin()));                                        // Admin
      }


    // Users collection
    match /users/{userId} {
      // Allow read/write only for the user themselves or an admin
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true; // Public read access
      // Allow create only for signed-in users
      allow create: if isSignedIn();
      // Allow update/delete only for admins
      allow update, delete: if isAdmin();
    }

    // Settings collection
    match /settings/{document} {
      allow read: if true; // Public read access
      // Allow write only for admins
      allow write: if isAdmin();
    }

    // SyncCalendars collection
    match /syncCalendars/{documentId} {
      // Allow read/write only for the property owner or an admin
      allow read, write: if isSignedIn() &&
                           (isOwner(resource.data.propertyId) || isAdmin());
    }

    // Coupons collection
    match /coupons/{couponId} {
      // Allow read access for everyone (needed by booking form validation)
      // Consider `if isSignedIn();` if coupons should only be visible/usable by logged-in users.
      allow read: if true;
      // Allow create/update/delete only for admins
      allow write: if isAdmin();
    }
    
    // App Config (e.g., currency rates)
    match /appConfig/{configDocId} {
        allow read: if true; // Allow public read for currency rates, etc.
        allow write: if isAdmin(); // Only admins can update configuration
    }
    
    // --- Inquiries Collection ---
    match /inquiries/{inquiryId} {
      	allow create: if true; // Allow anyone to create an inquiry
      	allow read, update: if isSignedIn() &&
                           (resource.data.guestInfo.email == request.auth.token.email || // User who made inquiry (if email matches)
                            isOwner(resource.data.propertySlug) ||           // Property owner
                            isAdmin());                                     // Admin
    }
    
    
    // --- NEW PRICING SYSTEM COLLECTIONS ---

    // --- Seasonal Pricing Collection ---
    // Document ID format typically: {propertyId}_{seasonName}_{year}
    match /seasonalPricing/{seasonId} {
      allow read: if true; // Public read for price calculations
      allow write: if isSignedIn() && 
                   (isOwner(resource.data.propertyId) || isAdmin());
    }

     // --- Date Overrides Collection ---
    // Document ID format: {propertyId}_{YYYY-MM-DD}
    match /dateOverrides/{overrideId} {
      allow read: if true; // Public read for price calculations
      // Production rules - require authentication and ownership
      allow create: if isSignedIn() &&
                    (isOwner(request.resource.data.propertyId) || isAdmin());
      allow update, delete: if isSignedIn() &&
                    (isOwner(resource.data.propertyId) || isAdmin());
    }

    // --- Minimum Stay Rules Collection ---
    match /minimumStayRules/{ruleId} {
      allow read: if true; // Public read for booking checks
      allow write: if isSignedIn() && 
                   (isOwner(resource.data.propertyId) || isAdmin());
    }

    // --- Holidays Collection ---
    match /holidays/{holidayId} {
      allow read: if true; // Public read for context
      allow write: if isAdmin(); // Only admins can define holidays
    }

    // --- Pricing Templates Collection ---
    match /pricingTemplates/{templateId} {
      allow read: if true; // Public read for templates
      allow write: if isAdmin(); // Only admins can manage templates
    }

     // --- Price Calendars Collection ---
    // Document ID format: {propertyId}_{YYYY-MM}
    match /priceCalendars/{calendarId} {
      allow read: if true; // Public read for price lookups
      // Production rules - admin only (calendars are generated by system/cron)
      // Note: Cron jobs use Admin SDK which bypasses these rules
      allow write: if isAdmin();
    }
    
  }
}
